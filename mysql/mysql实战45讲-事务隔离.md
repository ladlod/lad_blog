# mysql实战45讲-事务隔离
> 大家日常工作中一定对事务不陌生，无论是和数据库打交道，还是我们的分布式系统中，都经常需要用到事务，那么mysql事务之间的隔离是怎么实现的呢？
## 基础概念
### 什么是事务
**事务**是计算机常用的一种机制，包含了一组计算机操作指令，事务把所有指令作为一个整体一起向系统提交或撤销。即事务中的所有指令，要么都执行，要么都不执行，是一个不可分割的工作逻辑单元。
### 事务的特性
事务具有四个特性，**原子性(Atomicity)**，**一致性(Consistency)**，**隔离性(Isolation)**，**持久性(Durability)**
- **原子性**指事务是一个完整的操作，必须作为一个整体提交或回滚。
- **一致性**指事务执行前后，数据的完整性必须保持一致。
- **隔离性**指所有事务对数据的操作彼此之间是隔离的，事务之间是独立的，不应以任何方式依赖或影响其它事务。
- **持久性**指一个事务一旦被提交，它对数据的改变就是永久性的。
### 隔离性与隔离级别
当有多个事务并发操作同一数据时，如果隔离性没有保障，就可能出现**脏读(dirty read)**，**不可重复读(non-repeatable read)**，**幻读(phantom read)** 的问题。为了解决上述问题，就有了隔离级别的概念。

在谈隔离级别之前，我们应该可以想到，隔离的越严，效率就会越低，因此我们需要在二者之间找到一个平衡点。mysql将事务的隔离划分为四个级别，**读未提交(read uncommitted)**，**读提交(read committed)**，**可重复读(repeatable read)**，**串行化(serializable)**。
![隔离级别](assets/%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB.png)
#### 读未提交(read uncommitted)
不做任何隔离，一个事务还没commit时，它做的变更就可以被其它事务看到；在**读未提交**的隔离级别下，假设事务A修改某一数据后回滚，事务B查询事务A修改的值时，可能出现读到未提交的脏数据的情况，即**脏读**。
#### 读提交(read committed)
仅当一个事务commit之后，它做的变更才可以被其它事务看到；在**读提交**的隔离级别下，假设事务A修改某一数据，事务B在执行过程中两次查询了事务A修改的值时，可能出现两次查询结果不一致的情况，即**不可重复读**。
#### 可重复读(repeatable read)
一个事物执行过程中，总是和事务启动时看到的数据是一致的；在**可重复读**隔离级别下，假设事务A插入一条数据，事务B在执行过程中两次进行范围查询，可能出现两次查询结果不一致的情况，即**幻读**。
#### 串行化(serializable)
所有事务严格按照串行执行。
## InnoDB事务隔离的实现
### mysql的mvcc
> 在 MySQL 中，实际上每条记录在更新的时候都会同时记录一条回滚操作。记录上的最新值，通过回滚操作，都可以得到前一个状态的值。因此，在不同时刻开启的事务都可以根据回滚记录获取到当前的读视图(read-view)。这种视图读的方式，即我们常说的多版本并发控制(Multi-Version Concurrency Control)。
#### innodb的mvcc是怎么实现的？
!! 重点
#### read committed和repeatable read是怎么实现的？
innodb通过控制不同的视图创建时机，实现不同的隔离级别。在rc级别下，每次sql执行时创建read-view，在rr级别下，每个事务提交时创建read-view。
#### mvcc是否可以彻底解决重复读和幻读的问题？
在前面我们了解到，mvcc使得我们的读操作最终执行为读取read-view，在rr隔离级别下，其它事务无法修改当前事务使用的read-view，所以对**快照读**这一类行为，mvcc可以解决幻读问题。那么是否有查询行为不读取read-view，而是执行**当前读**呢？实际上，在rr隔离级别下，除了普通的select操作，其余操作都是**当前读**。如

``` select ... lock in share mode ```

``` select ... for update ```

``` update ..., delete ..., insert ... ```

我们使用一个case来具体看下，同时开启两个事务，在**快照读**时，事务1在事务2更新前后读取到的数据一致。而如果我们使用**当前读**，可以看到事务1在事务2更新后读取到的数据为最新数据。
![](assets/16667160080110.jpg)
#### 幻读会造成什么影响？
#### innodb怎么解决幻读？

## 事务的启动方式

## 案例case